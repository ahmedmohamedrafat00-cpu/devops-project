pipeline {
  agent any
  environment {
    DOCKERHUB_CREDENTIALS = 'dockerhub-creds'
    IMAGE_NAME = "ahmedmohamed1242001/backend"
    KUBE_NAMESPACE = "default"
    GIT_REPO = "https://github.com/ahmedmohamedrafat00-cpu/devops-project.git"
    AWS_REGION = "eu-west-1"
    EKS_CLUSTER_NAME = "devops-project-eks"
    AWS_ACCOUNT_ID = "985539792593"
  }
  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }
    stage('Build') {
      steps {
        sh 'echo "No build step yet (nginx test image)"'
      }
    }
    stage('Docker Build & Push') {
      steps {
        script {
          withCredentials([usernamePassword(
            credentialsId: env.DOCKERHUB_CREDENTIALS,
            usernameVariable: 'DOCKER_USER',
            passwordVariable: 'DOCKER_PASS'
          )]) {
            sh '''
              echo "Building Docker image..."
              cd apps/backend
              docker build -t ${IMAGE_NAME}:${BUILD_NUMBER} .
              echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
              docker push ${IMAGE_NAME}:${BUILD_NUMBER}
              cd ../..
            '''
          }
        }
      }
    }
    stage('Deploy to EKS (Helm)') {
      steps {
        withCredentials([
          string(credentialsId: 'aws-access-key-id', variable: 'AWS_ACCESS_KEY_ID'),
          string(credentialsId: 'aws-secret-access-key', variable: 'AWS_SECRET_ACCESS_KEY')
        ]) {
          sh '''
            echo "Configuring AWS and kubectl for EKS..."
            echo "Target: ${EKS_CLUSTER_NAME} in ${AWS_REGION} (Account: ${AWS_ACCOUNT_ID})"
            
            # Configure AWS credentials
            aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
            aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
            aws configure set region ${AWS_REGION}
            
            # Update kubeconfig for EKS cluster
            aws eks update-kubeconfig --name ${EKS_CLUSTER_NAME} --region ${AWS_REGION}
            
            # Verify connection
            echo "Testing cluster connection..."
            kubectl get nodes
            
            echo "Cloning full repo for Helm..."
            rm -rf helm-workspace
            git clone ${GIT_REPO} helm-workspace
            cd helm-workspace/k8s/charts/backend
            
            echo "Deploying with Helm..."
            helm upgrade --install backend . \
              --set image.repository=${IMAGE_NAME} \
              --set image.tag=${BUILD_NUMBER} \
              --namespace ${KUBE_NAMESPACE} \
              --wait \
              --timeout 5m
            
            echo "Deployment completed!"
            kubectl get pods -n ${KUBE_NAMESPACE} -l app=backend
          '''
        }
      }
    }
  }
  post {
    success {
      echo "‚úÖ CI/CD Pipeline Finished Successfully"
      echo "üöÄ Deployed ${IMAGE_NAME}:${BUILD_NUMBER} to EKS cluster: ${EKS_CLUSTER_NAME}"
      echo "üìç Region: ${AWS_REGION}"
    }
    failure {
      echo "‚ùå CI/CD Pipeline Failed"
    }
  }
}
